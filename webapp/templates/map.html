<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8" />
  <title>Listings Map</title>

  <!-- Leaflet CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
    crossorigin=""
  />
    <!-- Leaflet MarkerCluster CSS -->
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.css"
  />
  <link
    rel="stylesheet"
    href="https://unpkg.com/leaflet.markercluster@1.5.3/dist/MarkerCluster.Default.css"
  />

  <style>
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif;
      margin: 0;
      padding: 0;
    }
    .top-bar {
      padding: 0.75rem 1rem;
      border-bottom: 1px solid #ddd;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .top-bar a {
      text-decoration: none;
      color: #0070f3;
    }
    .filters-bar {
      padding: 0.5rem 1rem;
      border-bottom: 1px solid #eee;
      display: flex;
      flex-wrap: wrap;
      gap: 0.5rem;
      align-items: center;
      background: #fafafa;
      font-size: 0.9rem;
    }
    .filters-bar label {
      display: flex;
      flex-direction: column;
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.03em;
      color: #555;
    }
    .filters-bar input {
      padding: 0.25rem 0.4rem;
      font-size: 0.9rem;
      min-width: 6rem;
    }
    .filters-bar button {
      padding: 0.4rem 0.8rem;
      font-size: 0.9rem;
      border-radius: 4px;
      border: 1px solid #0070f3;
      background: #0070f3;
      color: white;
      cursor: pointer;
    }
    .filters-bar button.secondary {
      border-color: #ccc;
      background: white;
      color: #333;
      margin-left: 0.25rem;
    }
    #map {
      height: calc(100vh - 48px - 46px); /* top bar + filters bar */
      width: 100%;
    }
    @media (max-width: 600px) {
      #map {
        height: calc(100vh - 48px - 72px);
      }
    }
  </style>
</head>
<body>
  <div class="top-bar">
    <div>
      <strong>Listings Map</strong>
    </div>
    <div>
      <a href="{{ request.url_for('listings') }}">← Back to list</a>
      &nbsp;|&nbsp;
      <a href="{{ request.url_for('home') }}">Dashboard</a>
    </div>
  </div>
  <!-- Filters -->
  <form class="filters-bar" method="get" action="{{ request.url_for('map_view') }}">
    <label>
      Min Price
      <input
        type="number"
        name="min_price"
        min="0"
        step="50000"
        value="{{ min_price if min_price is not none else '' }}"
        placeholder="e.g. 800000"
      />
    </label>
    <label>
      Max Price
      <input
        type="number"
        name="max_price"
        min="0"
        step="50000"
        value="{{ max_price if max_price is not none else '' }}"
        placeholder="e.g. 1500000"
      />
    </label>
    <label>
      Min Beds
      <input
        type="number"
        name="min_beds"
        min="0"
        step="1"
        value="{{ min_beds if min_beds is not none else '' }}"
        placeholder="e.g. 2"
      />
    </label>
    <label>
      Min Baths
      <input
        type="number"
        name="min_baths"
        min="0"
        step="1"
        value="{{ min_baths if min_baths is not none else '' }}"
        placeholder="e.g. 2"
      />
    </label>

    <div>
      <button type="submit">Apply</button>
      <button
        type="button"
        class="secondary"
        onclick="window.location='{{ request.url_for('map_view') }}'"
      >
        Reset
      </button>
    </div>
  </form>

  <div id="map"></div>

  <!-- Leaflet JS -->
  <script
    src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
    integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
    crossorigin=""
  ></script>
  <!-- Leaflet MarkerCluster JS -->
  <script
    src="https://unpkg.com/leaflet.markercluster@1.5.3/dist/leaflet.markercluster.js"
  ></script>


  <script>
    // Data from backend
    const listingPoints = {{ listing_points | tojson }};

    // Listing ID to focus (if any)
    const focusId = {{ focus_id if focus_id is not none else 'null' }};

    // Default center (Vancouver-ish) if no data:
    let defaultCenter = [49.2827, -123.1207];
    if (listingPoints.length > 0) {
      // Start at the first listing; we'll also fit bounds below
      defaultCenter = [listingPoints[0].lat, listingPoints[0].lng];
    }

    // Initialize map
    const map = L.map("map").setView(defaultCenter, 12);

    // Base tile layer from OpenStreetMap
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      maxZoom: 19,
      attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    // Create a marker cluster group
    const clusterGroup = L.markerClusterGroup();

    // Keep a lookup from listing id -> marker
    const markerById = new Map();

    listingPoints.forEach((item) => {
      if (item.lat == null || item.lng == null) return;

      const price = item.price
        ? "$" + item.price.toLocaleString()
        : "Price unknown";

      const popupHtml = `
        <div>
            <strong>${price}</strong><br/>
            ${item.address ? item.address : "No address"}<br/>
            ${item.city || ""} ${item.neighbourhood || ""}<br/>
            ${item.url ? `<a href="${item.url}" target="_blank" rel="noopener noreferrer">View on REW</a>` : ""}
            <br/>
            ${item.detail_url ? `<a href="${item.detail_url}">View details</a>` : ""}
        </div>
        `;

      const marker = L.marker([item.lat, item.lng]).bindPopup(popupHtml);
      const label = `${price} – ${item.city || ""} ${item.neighbourhood || ""}`.trim();
      marker.bindTooltip(label, { direction: "top" });

      // Add marker to the cluster group instead of directly to the map
      clusterGroup.addLayer(marker);
      markerById.set(item.id, marker);
    });

    // Add the cluster group to the map
    map.addLayer(clusterGroup);

    // Fit bounds for all clustered markers
    if (clusterGroup.getLayers().length > 0) {
      map.fitBounds(clusterGroup.getBounds().pad(0.2));
    }
    // If a focusId was provided, zoom to that marker and open its popup
    if (focusId !== null) {
      const targetMarker = markerById.get(focusId);
      if (targetMarker) {
        clusterGroup.zoomToShowLayer(targetMarker, () => {
          targetMarker.openPopup();
        });
      }
    }
  </script>
</body>
</html>
